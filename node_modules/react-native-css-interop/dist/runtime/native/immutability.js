"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createDraftValue = exports.createDraftRecord = exports.createDraftSet = void 0;
function createDraftSet(set) {
    return {
        startDraft() {
            const draft = new Set();
            let mutated = false;
            return Object.assign(draft, {
                add(value) {
                    if (!value)
                        return draft;
                    if (!set.has(value)) {
                        mutated = true;
                    }
                    return draft.add(value);
                },
                didMutate() {
                    return mutated || draft.size !== set.size;
                },
                finalise() {
                    set = draft;
                    return set;
                },
            });
        },
    };
}
exports.createDraftSet = createDraftSet;
function createDraftRecord(record) {
    let originalKeys = new Set(Object.keys(record));
    return {
        startDraft() {
            const draft = {};
            const draftKeys = new Set();
            let mutated = false;
            const draftObj = {
                set(path, value) {
                    if (!originalKeys.has(path) && record[path] !== value) {
                        mutated = true;
                    }
                    draftKeys.add(path);
                    draft[path] = value;
                },
                logicalOrSet(path, value) {
                    if (draft[path])
                        return;
                    draftObj.set(path, value);
                },
                didMutate() {
                    return mutated || draftKeys.size !== originalKeys.size;
                },
                finalise() {
                    record = draft;
                    originalKeys = draftKeys;
                    return record;
                },
            };
            return draftObj;
        },
        get() {
            return record;
        },
    };
}
exports.createDraftRecord = createDraftRecord;
function createDraftValue(value) {
    return {
        startDraft() {
            let draft = undefined;
            return {
                set(newValue) {
                    draft = newValue;
                },
                didMutate() {
                    return Object.is(value, draft);
                },
                finalise() {
                    value = draft;
                    return value;
                },
            };
        },
    };
}
exports.createDraftValue = createDraftValue;
//# sourceMappingURL=immutability.js.map